# This is a sample nginx config file for a web server
# We will copy this file to the nginx config and replace the placeholders and use certbot to generate the ssl certs

# This stays in the same file, above the server block
# This stays above the server block
server {
  server_name DOMAIN_PLACEHOLDER app.DOMAIN_PLACEHOLDER www.DOMAIN_PLACEHOLDER;

  client_max_body_size 15M;

  # Homepage (/) → external Framer site
  location = / {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    # Allow logged-in user to access the webpage
    set $redirect_to_home 0;
    
    # Check if user has session cookie AND not from app
    if ($http_cookie ~* "__Secure-next-auth\.session-token=") {
        set $redirect_to_home 1;
    }
    
    if ($arg_from = "app") {
        set $redirect_to_home 0;
    }
    
    # Redirect only if conditions are met
    if ($redirect_to_home = 1) {
        return 302 /home;
    }

    proxy_pass https://HOMEPAGE_PLACEHOLDER/;
    proxy_set_header Host HOMEPAGE_PLACEHOLDER;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Original-Host $host;

    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_redirect off;
}


  # Framer pages → external Framer site
  location ~ ^/(pricing|contact-us|google-spam-policy|about-us|termofuse|cookie|gdpr-policy|privacy-policy)(/|$) {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    proxy_pass https://HOMEPAGE_PLACEHOLDER$request_uri;
    proxy_set_header Host HOMEPAGE_PLACEHOLDER;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_redirect off;
  }

  # Framer pages → external Framer site
  location ~ ^/(industry)(/|$) {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    proxy_pass https://HOMEPAGE_PLACEHOLDER$request_uri;
    proxy_set_header Host HOMEPAGE_PLACEHOLDER;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_redirect off;
  }

  # Framer pages → external Framer site
  location ~ ^/(use-case)(/|$) {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    proxy_pass https://HOMEPAGE_PLACEHOLDER$request_uri;
    proxy_set_header Host HOMEPAGE_PLACEHOLDER;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_redirect off;
  }

  # Roadmap page → dedicated external site
  # location = /roadmap {
  #   proxy_pass https://roadmap.DOMAIN_PLACEHOLDER;
  #   proxy_set_header Host roadmap.DOMAIN_PLACEHOLDER;
  #   proxy_set_header X-Real-IP $remote_addr;
  #   proxy_set_header X-Forwarded-Proto $scheme;
  #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_ssl_server_name on;
  #   proxy_ssl_verify off;
  #   proxy_redirect off;
  # }

  # API routes → local Next.js app
  location /api/ {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    proxy_pass http://127.0.0.1:PORT_PLACEHOLDER;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ~* ^/(login|signup|apps|auth|availability|bookings|home|event-types|getting-started|settings|teams|workflows|insights|signup|booking) {
    add_header Content-Security-Policy "frame-ancestors 'none'" always;
    add_header X-Frame-Options "DENY" always;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # continue with your app logic
    proxy_pass http://127.0.0.1:PORT_PLACEHOLDER;
  }

  # Everything else → local app
  location / {
    add_header Content-Security-Policy "frame-src *" always;

    proxy_pass http://127.0.0.1:PORT_PLACEHOLDER;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  listen 443 ssl;
  ssl_certificate /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# API subdomain → local service on port 5555
server {
  listen 443 ssl;
  server_name api.DOMAIN_PLACEHOLDER;

  client_max_body_size 15M;

  location / {
    proxy_pass http://127.0.0.1:5555;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_redirect off;
  }

  ssl_certificate /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Unauthorized subdomains → redirect to app
server {
  listen 443 ssl;
  server_name *.DOMAIN_PLACEHOLDER;

  if ($host !~* ^(app|www)\.DOMAIN_PLACEHOLDER$) {
    return 301 https://app.DOMAIN_PLACEHOLDER$request_uri;
  }

  ssl_certificate /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/DOMAIN_PLACEHOLDER/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP → HTTPS Redirection
server {
  if ($host = DOMAIN_PLACEHOLDER) {
    return 301 https://$host$request_uri;
  }

  if ($host ~ ^[^.]+\.DOMAIN_PLACEHOLDER$) {
    return 301 https://$host$request_uri;
  }

  listen 80;
  server_name DOMAIN_PLACEHOLDER *.DOMAIN_PLACEHOLDER;
  return 404;
}