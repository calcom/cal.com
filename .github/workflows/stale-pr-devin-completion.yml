name: Stale Community PR Devin Completion

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to complete'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  complete-stale-pr:
    name: Trigger Devin to Complete Stale Community PR
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event.label.name == 'stale'
    runs-on: blacksmith-2vcpu-ubuntu-2404
    steps:
      - name: Get PR details and check author activity
        id: pr
        uses: actions/github-script@v7
        env:
          INPUT_PR_NUMBER: ${{ inputs.pr_number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const ONE_MONTH_MS = 30 * 24 * 60 * 60 * 1000;
            const now = new Date();
            let prNumber;
            let pr;

            if (context.eventName === 'workflow_dispatch') {
              const inputPrNumber = process.env.INPUT_PR_NUMBER;
              prNumber = parseInt(inputPrNumber, 10);
              if (isNaN(prNumber) || prNumber <= 0) {
                core.setFailed(`Invalid PR number provided: "${inputPrNumber}". Please enter a valid PR number.`);
                return;
              }
              const { data } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              pr = data;
            } else {
              pr = context.payload.pull_request;
              prNumber = pr.number;
            }

            if (!pr.head.repo) {
              core.setFailed('Cannot complete this PR: the source repository (fork) has been deleted.');
              return;
            }

            const isFork = pr.head.repo.fork || pr.head.repo.full_name !== pr.base.repo.full_name;
            const maintainerCanModify = pr.maintainer_can_modify;
            const prAuthor = pr.user.login;

            let shouldMigrate = false;

            if (isFork) {
              let hasRecentAuthorActivity = false;

              const commentsResponse = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: prNumber,
                per_page: 100
              });

              const recentAuthorComment = commentsResponse.data.find(comment => {
                const commentDate = new Date(comment.created_at);
                const isRecent = (now - commentDate) < ONE_MONTH_MS;
                const isFromAuthor = comment.user?.login === prAuthor;
                return isRecent && isFromAuthor;
              });

              if (recentAuthorComment) {
                hasRecentAuthorActivity = true;
              }

              const commitsResponse = await github.rest.pulls.listCommits({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100
              });

              if (!hasRecentAuthorActivity) {
                const recentAuthorCommit = commitsResponse.data.find(commit => {
                  const commitDate = new Date(commit.commit.committer?.date || commit.commit.author?.date);
                  const isRecent = (now - commitDate) < ONE_MONTH_MS;
                  const isFromAuthor = commit.author?.login === prAuthor || commit.committer?.login === prAuthor;
                  return isRecent && isFromAuthor;
                });

                if (recentAuthorCommit) {
                  hasRecentAuthorActivity = true;
                }
              }

              if (hasRecentAuthorActivity) {
                if (!maintainerCanModify) {
                  core.setFailed(`Cannot complete this fork PR: the fork owner has not enabled "Allow edits from maintainers". PR author needs to enable this setting.`);
                  return;
                }
              } else {
                shouldMigrate = true;
                console.log(`Fork PR #${prNumber} author has been inactive for 1 month - will migrate to main repo`);
              }
            }

            const headRepoFullName = pr.head.repo.full_name;
            const headRepoCloneUrl = pr.head.repo.clone_url;

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_body', pr.body || '');
            core.setOutput('pr_author', prAuthor);
            core.setOutput('pr_branch', pr.head.ref);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('is_fork', isFork);
            core.setOutput('head_repo_full_name', headRepoFullName);
            core.setOutput('head_repo_clone_url', headRepoCloneUrl);
            core.setOutput('maintainer_can_modify', maintainerCanModify);
            core.setOutput('should_migrate', shouldMigrate);

            console.log(`PR #${prNumber}: "${pr.title}"`);
            console.log(`Author: ${prAuthor}`);
            console.log(`Branch: ${pr.head.ref}`);
            console.log(`Is fork: ${isFork}`);
            console.log(`Head repo: ${headRepoFullName}`);
            console.log(`Maintainer can modify: ${maintainerCanModify}`);
            console.log(`Should migrate: ${shouldMigrate}`);

      - name: Create Devin session for PR completion
        if: steps.pr.outputs.should_migrate != 'true'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.pr.outputs.pr_author }}
          PR_BRANCH: ${{ steps.pr.outputs.pr_branch }}
          IS_FORK: ${{ steps.pr.outputs.is_fork }}
          HEAD_REPO_FULL_NAME: ${{ steps.pr.outputs.head_repo_full_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          if [ "$IS_FORK" = "true" ]; then
            CLONE_INSTRUCTIONS="This is a fork PR. Clone from the fork repository: ${HEAD_REPO_FULL_NAME}

          To check out this PR:
          1. Clone the fork: git clone https://github.com/${HEAD_REPO_FULL_NAME}.git
          2. Check out the branch: git checkout ${PR_BRANCH}
          3. Add the upstream remote: git remote add upstream https://github.com/${REPO_NAME}.git"
          else
            CLONE_INSTRUCTIONS="Clone the repository ${REPO_NAME} and check out the branch: ${PR_BRANCH}"
          fi

          FULL_PROMPT="You are completing a stale community PR #${PR_NUMBER} in repository ${REPO_NAME}.

          This PR was started by @${PR_AUTHOR} but has become stale. Your job is to complete it.

          PR Title: ${PR_TITLE}
          PR Branch: ${PR_BRANCH}

          ${CLONE_INSTRUCTIONS}

          Your tasks:
          1. Clone the repository as described above.
          2. Check out the PR branch: ${PR_BRANCH}
          3. Review the current state of the PR and understand what it's trying to accomplish.
          4. Read the PR description and any comments/review feedback on the PR.
          5. Complete any unfinished work on the PR:
             - Fix any issues mentioned in review comments
             - Ensure the code follows the repository's coding standards
             - Add any missing tests if applicable
             - Fix any linting or type errors
          6. Run the appropriate checks (lint, type-check, tests) to ensure the PR is ready for review.
          7. Commit your changes with clear commit messages.
          8. Push your changes to the PR branch.
          9. Post a summary comment on the PR explaining what you completed.
          10. Remove the 'stale' label from the PR if you've completed the work.
          11. Mark the PR as ready for review if applicable.

          Rules and Guidelines:
          1. Respect the original author's intent and approach - don't rewrite the PR from scratch.
          2. Make minimal, focused changes that complete the PR's original goal.
          3. Follow the existing code style and conventions in the repository.
          4. If the PR's original approach seems fundamentally flawed, explain why in a comment instead of making major changes.
          5. Never ask for user confirmation. Never wait for user messages.
          6. Credit the original author in your commit messages where appropriate."

          RESPONSE=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer ${DEVIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$FULL_PROMPT" \
              --arg title "Complete Stale PR #${PR_NUMBER}: ${PR_TITLE}" \
              '{
                prompt: $prompt,
                title: $title,
                tags: ["stale-pr-completion", "pr-'${PR_NUMBER}'"]
              }')")

          SESSION_URL=$(echo "$RESPONSE" | jq -r '.url // .session_url // empty')
          if [ -n "$SESSION_URL" ]; then
            echo "Devin session created: $SESSION_URL"
            echo "SESSION_URL=$SESSION_URL" >> $GITHUB_ENV
          else
            echo "Failed to create Devin session"
            exit 1
          fi

      - name: Create Devin session for fork PR migration
        if: steps.pr.outputs.should_migrate == 'true'
        env:
          DEVIN_API_KEY: ${{ secrets.DEVIN_API_KEY }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          PR_TITLE: ${{ steps.pr.outputs.pr_title }}
          PR_AUTHOR: ${{ steps.pr.outputs.pr_author }}
          PR_BRANCH: ${{ steps.pr.outputs.pr_branch }}
          BASE_BRANCH: ${{ steps.pr.outputs.base_branch }}
          HEAD_REPO_FULL_NAME: ${{ steps.pr.outputs.head_repo_full_name }}
          REPO_NAME: ${{ github.repository }}
        run: |
          FULL_PROMPT="You are migrating a stale fork PR #${PR_NUMBER} to the main ${REPO_NAME} repository.

          The original PR author (@${PR_AUTHOR}) has not been active on this PR for over a month, so we are migrating it to the main repository to complete the work.

          Original PR Details:
          - PR Number: #${PR_NUMBER}
          - PR Title: ${PR_TITLE}
          - Original Author: @${PR_AUTHOR}
          - Fork Repository: ${HEAD_REPO_FULL_NAME}
          - Fork Branch: ${PR_BRANCH}
          - Target Branch: ${BASE_BRANCH}

          Your tasks:

          1. Clone the main repository and fetch the fork's PR branch
          2. Create a new branch named community/pr-${PR_NUMBER}-${PR_BRANCH} based on ${BASE_BRANCH}
          3. Cherry-pick the commits from the fork branch to preserve the original author attribution (git cherry-pick preserves authorship automatically)
          4. Run lint and type checks to ensure the code is valid, fixing any issues that arise
          5. Push the new branch and create a new PR in the main repository with the same title and description, crediting the original author @${PR_AUTHOR}
          6. Close the original fork PR #${PR_NUMBER} with a comment thanking the author and linking to the new PR
          7. Remove the 'stale' label from the original PR

          IMPORTANT - Preserving Original Authorship:
          Use git cherry-pick to apply commits from the fork branch. This automatically preserves the original author information on each commit, so @${PR_AUTHOR} will be credited as the author of their commits even though they are not a member of the ${REPO_NAME} repository. GitHub will properly attribute the commits to them.

          Rules and Guidelines:
          1. Preserve the original author's work and authorship as much as possible.
          2. Follow the existing code style and conventions in the repository.
          3. If the code has significant issues, fix them but document what you changed.
          4. Never ask for user confirmation. Never wait for user messages.
          5. If you encounter any blocking issues, document them in a comment on the original PR."

          RESPONSE=$(curl -s -X POST "https://api.devin.ai/v1/sessions" \
            -H "Authorization: Bearer ${DEVIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$FULL_PROMPT" \
              --arg title "Migrate Fork PR #${PR_NUMBER}: ${PR_TITLE}" \
              '{
                prompt: $prompt,
                title: $title,
                tags: ["fork-migration", "pr-'${PR_NUMBER}'"]
              }')")

          SESSION_URL=$(echo "$RESPONSE" | jq -r '.url // .session_url // empty')
          if [ -n "$SESSION_URL" ]; then
            echo "Devin session created: $SESSION_URL"
            echo "SESSION_URL=$SESSION_URL" >> $GITHUB_ENV
          else
            echo "Failed to create Devin session"
            exit 1
          fi

      - name: Post comment with Devin session link
        if: env.SESSION_URL != ''
        uses: actions/github-script@v7
        env:
          PR_AUTHOR: ${{ steps.pr.outputs.pr_author }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          SHOULD_MIGRATE: ${{ steps.pr.outputs.should_migrate }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sessionUrl = process.env.SESSION_URL;
            const prAuthor = process.env.PR_AUTHOR;
            const prNumber = process.env.PR_NUMBER;
            const shouldMigrate = process.env.SHOULD_MIGRATE === 'true';
            const { owner, repo } = context.repo;

            let body;
            if (shouldMigrate) {
              body = `### Devin AI is migrating this PR

            This fork PR has been inactive for over a month. To help complete this contribution, we are migrating it to a branch in the main repository.

            [View Devin Session](${sessionUrl})

            **What's happening:**
            1. Your changes will be copied to a new branch in the main \`${owner}/${repo}\` repository
            2. A new PR will be created with your changes
            3. You will remain the author of your commits (full attribution preserved)
            4. This PR will be closed once the migration is complete

            Thank you for your contribution, @${prAuthor}! We appreciate your work and want to make sure it gets completed.

            ---
            *If you'd prefer to complete this PR yourself, please let us know and we'll cancel the migration.*`;
            } else {
              body = `### Devin AI is completing this stale PR

            This PR by @${prAuthor} has been marked as stale. A Devin session has been created to complete the remaining work.

            [View Devin Session](${sessionUrl})

            ---
            *Devin will review the PR, address any feedback, and push updates to complete this PR.*`;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: parseInt(prNumber),
              body
            });
