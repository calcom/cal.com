name: E2E Report

on:
  workflow_run:
    workflows: ["PR Update"]
    types:
      - completed

jobs:
  get-pr-info:
    name: Get PR Info
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    permissions:
      actions: read
    outputs:
      pr-number: ${{ steps.get-pr.outputs.pr-number }}
      head-branch: ${{ steps.get-pr.outputs.head-branch }}
      has-blob-reports: ${{ steps.check-artifacts.outputs.has-blob-reports }}
    steps:
      - name: Get PR number from workflow run
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = context.payload.workflow_run.head_sha;
            const headBranch = context.payload.workflow_run.head_branch;
            
            console.log('Head SHA:', headSha);
            console.log('Head Branch:', headBranch);
            
            // Try to get PR number from workflow_run payload first
            if (context.payload.workflow_run.pull_requests && context.payload.workflow_run.pull_requests.length > 0) {
              const prNumber = context.payload.workflow_run.pull_requests[0].number;
              console.log('PR number from payload:', prNumber);
              core.setOutput('pr-number', prNumber);
              core.setOutput('head-branch', headBranch);
              return;
            }
            
            // Fall back to API lookup
            try {
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: headSha
              });
              
              if (prs.length === 0) {
                console.log('No PRs found for commit');
                core.setOutput('pr-number', '');
                core.setOutput('head-branch', headBranch);
                return;
              }
              
              // Find open PR or use first one
              const openPr = prs.find(pr => pr.state === 'open') || prs[0];
              console.log('PR number from API:', openPr.number);
              core.setOutput('pr-number', openPr.number);
              core.setOutput('head-branch', openPr.head.ref);
            } catch (e) {
              console.log('Error fetching PR:', e);
              core.setOutput('pr-number', '');
              core.setOutput('head-branch', headBranch);
            }

      - name: Check for blob report artifacts
        id: check-artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            
            try {
              const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });
              
              const blobReports = artifacts.artifacts.filter(a => a.name.startsWith('blob-report-'));
              console.log('Found blob reports:', blobReports.map(a => a.name));
              
              core.setOutput('has-blob-reports', blobReports.length > 0 ? 'true' : 'false');
            } catch (e) {
              console.log('Error checking artifacts:', e);
              core.setOutput('has-blob-reports', 'false');
            }

  merge-reports:
    name: Merge reports
    needs: [get-pr-info]
    if: ${{ needs.get-pr-info.outputs.has-blob-reports == 'true' && needs.get-pr-info.outputs.pr-number != '' }}
    uses: ./.github/workflows/merge-reports.yml
    with:
      source_run_id: ${{ github.event.workflow_run.id }}
      source_run_number: ${{ github.event.workflow_run.run_number }}
      source_run_attempt: ${{ github.event.workflow_run.run_attempt }}
      source_head_sha: ${{ github.event.workflow_run.head_sha }}
    secrets: inherit

  publish-report:
    name: Publish HTML report
    needs: [get-pr-info, merge-reports]
    if: ${{ needs.get-pr-info.outputs.pr-number != '' }}
    uses: ./.github/workflows/publish-report.yml
    with:
      head_branch: ${{ needs.get-pr-info.outputs.head-branch }}
      source_run_id: ${{ github.event.workflow_run.id }}
      source_run_number: ${{ github.event.workflow_run.run_number }}
      source_run_attempt: ${{ github.event.workflow_run.run_attempt }}
      pr_number: ${{ needs.get-pr-info.outputs.pr-number }}
    secrets: inherit
